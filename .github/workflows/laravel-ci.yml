name: Laravel CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    # Use PHP 8.2 (Laravel 12 requires PHP 8.2+)
    strategy:
      matrix:
        php-version: ['8.2']
    
    # Optional: MySQL service for integration tests if needed
    # Uncomment if you need a real database for tests
    # services:
      # mysql:
      #   image: mysql:8.0
      #   env:
      #     MYSQL_ROOT_PASSWORD: password
      #     MYSQL_DATABASE: testing
      #   ports:
      #     - 3306:3306
        # options: >-
        #   --health-cmd="mysqladmin ping"
        #   --health-interval=10s
        #   --health-timeout=5s
        #   --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, pdo, pdo_mysql, pdo_sqlite, bcmath, xml, ctype, fileinfo, json, tokenizer, curl, zip, gd
          coverage: none
      
      - name: Setup Composer cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: composer install --no-interaction --no-progress --prefer-dist
      
      - name: Copy environment file
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
      
      - name: Generate application key
        run: php artisan key:generate
      
      # Optional: Laravel Pint (code style).
      # Enable if the project includes laravel/pint as dev dependency.
      - name: Run Laravel Pint (Code Style)
        run: ./vendor/bin/pint --test
        continue-on-error: false
        
      # Required-ish: running tests.
      # If the project has tests, this should stay.
      # If not yet, it will just fail; users can comment it out or add tests.
      # - name: Run tests
      #   run: |
      #     php artisan migrate --force
      #     php artisan test
      #   env:
      #     APP_ENV: testing
      #     DB_CONNECTION: mysql
      #     DB_HOST: 127.0.0.1
      #     DB_PORT: 3306
      #     DB_DATABASE: testing
      #     DB_USERNAME: root
      #     DB_PASSWORD: password
          # By default, use .env.testing or fallback to sqlite config if defined there.
          # For MySQL-based testing, override these in .env.testing or adjust env here.

      # Optional: Larastan / PHPStan (static analysis).
      # Enable if phpstan/larastan is installed.
      # Set continue-on-error to false if you want it to be strict.
      - name: Run Larastan (Static Analysis)
        run: ./vendor/bin/phpstan analyse --memory-limit=2G
        continue-on-error: true
        # Note: Set continue-on-error to false if you want static analysis to fail the build


  # Optional: Frontend build (for projects using Vite / frontend assets).
  # Uncomment this block if the CMS generator (or generated apps) rely on npm build.
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
      
      - name: Install npm dependencies
        run: npm ci
      
      - name: Build frontend assets
        run: npm run build
      
      # Optional: Verify build output exists
      - name: Verify build output
        run: |
          if [ ! -d "public/build" ]; then
            echo "Build output directory not found!"
            exit 1
          fi

